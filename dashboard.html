<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi cuenta | LogopediaApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-body">

      <h4 class="mb-4">Mi cuenta</h4>

      <!-- PERFIL -->
      <div class="row align-items-center mb-4">
        <div class="col-md-3 text-center">
          <img id="userImage"
               src=""
               alt="Foto perfil"
               class="rounded-circle mb-3"
               style="width:120px;height:120px;object-fit:cover;display:none;">
        </div>

        <div class="col-md-9">
          <h5 id="userName"></h5>
          <p class="mb-1"><strong>Email:</strong> <span id="userEmail"></span></p>
          <p class="mb-1"><strong>Rol:</strong> <span id="userRole"></span></p>
          <p class="mb-1"><strong>Centro:</strong> <span id="userCenter"></span></p>
          <p class="mb-1"><strong>Especialidad:</strong> <span id="userSpecialty"></span></p>
          <p class="mb-1"><strong>Poblaci√≥n:</strong> <span id="userCity"></span></p>
          <p class="mb-1" id="subscriptionRow">
            <strong>Suscripci√≥n:</strong> <span id="userPlan"></span>
          </p>
        </div>
      </div>

      <hr>

    <div id="patientsSection">
  <h5 class="mt-3">Pacientes asociados</h5>

    <ul id="patientsList" class="list-group mb-3"></ul>

    <p id="noPatients" class="text-muted" style="display:none;">
      No tienes pacientes asociados.
    </p>

  <hr>
</div>

<div id="patientExtras" style="display:none">

  <h5 class="mt-3">Profesional asignado</h5>
  <ul id="professionalsList" class="list-group mb-3"></ul>

  <h5 class="mt-3">Mis documentos</h5>
  <div id="patientDocuments"></div>

  <hr>
</div>



  <hr>
      <button class="btn btn-outline-danger" onclick="logout()">
        Cerrar sesi√≥n
      </button>
    </div>
  </div>
</div>

<script src="js/firebase-init.js"></script>

<script>
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    document.getElementById("userEmail").textContent = user.email;
    const uid = user.uid;

    // üîç Intentar PROFESIONAL
    db.collection("profesionales").doc(uid).get()
      .then(doc => {
        if (doc.exists) {
          // ===== PROFESIONAL =====
          pintarDatosUsuario(doc.data(), "PROFESIONAL");

          // Mostrar secciones profesionales
          document.getElementById("subscriptionRow").style.display = "block";
          document.getElementById("patientsSection").style.display = "block";

          cargarPacientesProfesional(uid);
        } else {
          // üîç Intentar PACIENTE
          return db.collection("pacientes").doc(uid).get()
            .then(pacienteDoc => {
              if (pacienteDoc.exists) {
                pintarDatosUsuario(pacienteDoc.data(), "PACIENTE");

                // Ocultar lo que NO aplica
                document.getElementById("subscriptionRow").style.display = "none";
                document.getElementById("patientsSection").style.display = "none";

                // Mostrar extras del paciente
                document.getElementById("patientExtras").style.display = "block";

                // üë®‚Äç‚öïÔ∏è profesional asignado
                cargarProfesionalesPaciente(pacienteDoc.data());

                // üìÇ documentos del propio paciente
                cargarDocumentosPaciente(
                  uid,
                  document.getElementById("patientDocuments"),
                  null
                );
              }
 else {
                alert("No se encontraron datos del usuario");
              }
            });
        }
      })
      .catch(err => {
        console.error("Error cargando datos:", err);
      });
  });

  function pintarDatosUsuario(data, rol) {
    document.getElementById("userName").textContent = data.nombreCompleto || "";
    document.getElementById("userRole").textContent = rol;
    document.getElementById("userCenter").textContent =
      data.centroTrabajo || data.ubicacionClinica || "-";

    document.getElementById("userSpecialty").textContent =
      rol === "PROFESIONAL" ? (data.especialidad || "-") : "-";

    document.getElementById("userCity").textContent = data.poblacion || "-";

    if (rol === "PROFESIONAL") {
      document.getElementById("userPlan").textContent =
        data.tieneSuscripcion ? "Activa" : "Sin suscripci√≥n";
    }

    if (data.imagen) {
      const img = document.getElementById("userImage");
      img.src = data.imagen;
      img.style.display = "block";
    }
  }

 function cargarPacientesProfesional(uidProfesional) {
  const list = document.getElementById("patientsList");
  const noPatients = document.getElementById("noPatients");

  list.innerHTML = "";
  noPatients.style.display = "none";

  db.collection("pacientes")
    .where("profesionalUids", "array-contains", uidProfesional)
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        noPatients.style.display = "block";
        return;
      }

      let index = 0;

      snapshot.forEach(doc => {
        const p = doc.data();
        const pacienteId = doc.id;
        const collapseId = `collapse-${pacienteId}-${index++}`;

        const li = document.createElement("li");
        li.className = "list-group-item";

        li.innerHTML = `
          <div class="accordion" id="accordion-${pacienteId}">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#${collapseId}">
                  
                  <div class="w-100 d-flex justify-content-between align-items-center">
                    <div>
                      <strong>${p.nombreCompleto}</strong><br>
                      <small class="text-muted">
                        ${p.edad ? p.edad + " a√±os ¬∑ " : ""}
                        ${p.centroColegio || ""}
                      </small>
                    </div>

                    <span class="badge bg-secondary ms-3"
                          id="count-${pacienteId}">
                      0 docs
                    </span>
                  </div>

                </button>
              </h2>

              <div id="${collapseId}" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <div id="docs-${pacienteId}">
                    <small class="text-muted">Cargando documentos‚Ä¶</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        list.appendChild(li);

        // üìÇ cargar documentos reales
        const docsContainer = document.getElementById(`docs-${pacienteId}`);
        const counter = document.getElementById(`count-${pacienteId}`);

        cargarDocumentosPaciente(pacienteId, docsContainer, counter);
      });
    });
}

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    });
  }
</script>

<script>
function cargarDocumentosPaciente(pacienteId, container, counter) {
  container.innerHTML = "";

  db.collection("pacientes")
    .doc(pacienteId)
    .collection("documentos")
    .orderBy("fechaSubida", "desc")
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        container.innerHTML =
          `<small class="text-muted">Sin documentos</small>`;
        if (counter) counter.textContent = "0 docs";
        return;
      }

      if (counter) counter.textContent = `${snapshot.size} docs`;

      snapshot.forEach(doc => {
        const d = doc.data();

        const fecha = d.fechaSubida
          ? new Date(d.fechaSubida).toLocaleDateString()
          : "";

        const item = document.createElement("div");
        item.className = "border rounded p-2 mb-2";

        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${d.nombreDocumento || "Documento"}</strong><br>
              <small class="text-muted">${fecha}</small>
            </div>

            <div class="btn-group">
              

             <button class="btn btn-sm btn-outline-primary"
  onclick="descargarDesdeFirebase(
    '${d.urlDocumento}',
    '${d.nombreDocumento}'
  )">
  Descargar
</button>


            </div>
          </div>
        `;


        container.appendChild(item);
      });
    })
    .catch(err => {
      console.error("Error cargando documentos:", err);
      container.innerHTML =
        `<small class="text-danger">Error cargando documentos</small>`;
      if (counter) counter.textContent = "!";
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
  //Esto hace que se vea el acordeon para la descarga de documentos
</script>
<script>
function descargarDesdeFirebase(urlOriginal, nombreArchivo) {
  const url = new URL(urlOriginal);
  url.searchParams.set(
    "response-content-disposition",
    `attachment; filename="${nombreArchivo}"`
  );

  window.open(url.toString(), "_blank");
}
</script>
<script>
function cargarProfesionalesPaciente(dataPaciente) {
  const list = document.getElementById("professionalsList");
  list.innerHTML = "";

  const profesionales = dataPaciente.profesionalIds || [];

  if (profesionales.length === 0) {
    list.innerHTML =
      `<li class="list-group-item text-muted">
        No tienes profesional asignado
      </li>`;
    return;
  }

  profesionales.forEach(p => {
    const li = document.createElement("li");
    li.className = "list-group-item";

    li.innerHTML = `
      <strong>${p.nombreCompleto || "Profesional"}</strong><br>
      <small class="text-muted">
        ${p.centroTrabajo || ""}
      </small>
    `;

    list.appendChild(li);
  });
}
</script>
</body>
</html>
