<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel clínico | LogopediaApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .card { border-radius: 16px; }

    .profile-card {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .patient-card {
      cursor: pointer;
      border: 1px solid #e9ecef;
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      background: #fff;
      transition: all .2s ease;
    }

    .patient-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }

    .patient-avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 12px;
    }
  </style>
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="dashboard.html">LogopediaApp</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link active fw-semibold" href="dashboard.html">Panel clínico</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="tools.html">Herramientas digitales</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">

  <!-- TITLE -->
  <div class="mb-4">
    <h3 class="fw-bold">Panel clínico</h3>
    <p class="text-muted">Gestión de información terapéutica</p>
  </div>

  <!-- PERFIL (COMÚN) -->
  <div class="card p-4 mb-4">
    <div class="profile-card">
      <img id="userImage" class="rounded-circle"
           style="width:96px;height:96px;object-fit:cover;display:none;">
      <div>
        <h5 id="userName"></h5>
        <p class="mb-1"><strong>Centro:</strong> <span id="userCenter"></span></p>
        <p class="mb-1"><strong>Especialidad:</strong> <span id="userSpecialty"></span></p>
        <p class="mb-1"><strong>Población:</strong> <span id="userCity"></span></p>
        <p class="mb-0"><strong>Email:</strong> <span id="userEmail"></span></p>
      </div>
    </div>
  </div>

  <!-- ================= PROFESIONAL ================= -->
  <div id="vistaProfesional" style="display:none">
    <h5 class="mb-3">Pacientes en seguimiento</h5>
    <div id="patientsGrid" class="row g-4 mb-4"></div>
    <p id="noPatients" class="text-muted" style="display:none">
      No hay pacientes asociados
    </p>

    <div id="patientDetail" class="card p-4 mb-4" style="display:none">
      <h5 id="patientDetailName" class="mb-3"></h5>
      <div id="patientDetailDocs"></div>
    </div>
  </div>

  <!-- ================= PACIENTE ================= -->
  <div id="vistaPaciente" style="display:none">
    <div class="card p-4 mb-4">
      <h5 class="mb-3">Mis documentos</h5>
      <div id="patientDocuments"></div>
    </div>

    <div class="card p-4 mb-4">
      <h5 class="mb-3">Mi profesional</h5>
      <ul id="professionalsList" class="list-group"></ul>
    </div>
  </div>

  <button class="btn btn-sm btn-outline-secondary mb-5" onclick="logout()">
    Cerrar sesión
  </button>

</div>

<!-- FIREBASE INIT -->
<script src="js/firebase-init.js"></script>

<script>
auth.onAuthStateChanged(user => {
  if (!user) return location.href = "login.html";

  userEmail.textContent = user.email;
  const uid = user.uid;

  // ===== PROFESIONAL =====
  db.collection("profesionales").doc(uid).get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      pintarPerfilProfesional(data);
      vistaProfesional.style.display = "block";
      vistaPaciente.style.display = "none";
      cargarPacientesProfesional(uid);
    } else {
      // ===== PACIENTE =====
      db.collection("pacientes").doc(uid).get().then(pDoc => {
        if (!pDoc.exists) return alert("No se encontraron datos");

        const data = pDoc.data();
        pintarPerfilPaciente(data);
        vistaProfesional.style.display = "none";
        vistaPaciente.style.display = "block";

        cargarDocumentosPaciente(uid, patientDocuments);
        cargarProfesionalesPaciente(data);
      });
    }
  });
});

/* ===== PERFIL ===== */

function pintarPerfilProfesional(data) {
  userName.textContent = data.nombreCompleto || "";
  userCenter.textContent = data.centroTrabajo || "-";
  userSpecialty.textContent = data.especialidad || "-";
  userCity.textContent = data.poblacion || "-";

  if (data.imagen) {
    userImage.src = data.imagen;
    userImage.style.display = "block";
  }
}

function pintarPerfilPaciente(data) {
  userName.textContent = data.nombreCompleto || "";
  userCenter.textContent = data.centroLogopedia || "-";
  userSpecialty.textContent = "-";
  userCity.textContent = data.poblacion || "-";

  if (data.imagen) {
    userImage.src = data.imagen;
    userImage.style.display = "block";
  }
}

/* ===== PROFESIONAL ===== */

function cargarPacientesProfesional(uid) {
  patientsGrid.innerHTML = "";
  noPatients.style.display = "none";

  db.collection("pacientes")
    .where("profesionalUids", "array-contains", uid)
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        noPatients.style.display = "block";
        return;
      }

      snapshot.forEach(doc => {
        const p = doc.data();
        const col = document.createElement("div");
        col.className = "col-md-4 col-sm-6";

        col.innerHTML = `
          <div class="patient-card"
               onclick="abrirPaciente('${doc.id}', '${p.nombreCompleto}')">
            <img src="${p.imagen || 'https://via.placeholder.com/150'}"
                 class="patient-avatar">
            <div class="fw-semibold">${p.nombreCompleto}</div>
            <small class="text-muted">${p.edad || ""} años</small>
          </div>
        `;

        patientsGrid.appendChild(col);
      });
    });
}

function abrirPaciente(pacienteId, nombre) {
  patientDetail.style.display = "block";
  patientDetailName.textContent = nombre;
  cargarDocumentosPaciente(pacienteId, patientDetailDocs);
}

/* ===== DOCUMENTOS ===== */

function cargarDocumentosPaciente(pacienteId, container) {
  container.innerHTML = "";

  db.collection("pacientes")
    .doc(pacienteId)
    .collection("documentos")
    .orderBy("fechaSubida", "desc")
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        container.innerHTML =
          "<small class='text-muted'>No hay documentos</small>";
        return;
      }

      snapshot.forEach(doc => {
        const d = doc.data();
        container.innerHTML += `
          <div class="border rounded p-2 mb-2 d-flex justify-content-between">
            <div>
              <strong>${d.nombreDocumento}</strong><br>
              <small class="text-muted">
                ${new Date(d.fechaSubida).toLocaleDateString()}
              </small>
            </div>
            <button class="btn btn-sm btn-outline-primary"
              onclick="descargarDesdeFirebase('${d.urlDocumento}','${d.nombreDocumento}')">
              Exportar
            </button>
          </div>
        `;
      });
    });
}

/* ===== PACIENTE ===== */

function cargarProfesionalesPaciente(data) {
  professionalsList.innerHTML = "";

  (data.profesionalIds || []).forEach(p => {
    professionalsList.innerHTML += `
      <li class="list-group-item">
        <strong>${p.nombreCompleto || "Profesional"}</strong>
      </li>
    `;
  });
}

/* ===== UTIL ===== */

function descargarDesdeFirebase(url, nombre) {
  const u = new URL(url);
  u.searchParams.set(
    "response-content-disposition",
    `attachment; filename="${nombre}"`
  );
  window.open(u.toString(), "_blank");
}

function logout() {
  auth.signOut().then(() => location.href = "login.html");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
